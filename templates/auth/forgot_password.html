{% extends "base.html" %}

{% block title %}Forgot Password - Kizuna{% endblock %}

{% block content %}
<div class="auth-page">
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <img src="{{ url_for('static', filename='images/kizuna-logo.svg') }}" alt="Kizuna" class="auth-logo">
                <h1>Reset Password</h1>
                <p id="subtitle">Enter your email to receive a reset link</p>
            </div>

            <form id="forgot-form" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <label class="form-label" for="email">Email</label>
                    <input type="email" id="email" name="email" class="form-input" required autofocus>
                </div>

                <button type="submit" class="btn btn-primary btn-full btn-lg" id="submit-btn">Send Reset Link</button>
            </form>

            <div id="success-state" style="display: none;">
                <div class="email-sent-animation">
                    <div class="email-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                            <polyline points="22,6 12,13 2,6"></polyline>
                        </svg>
                        <div class="checkmark-circle">
                            <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <circle cx="12" cy="12" r="10" fill="none" stroke="#10b981" stroke-width="2"/>
                                <path class="checkmark-check" fill="none" stroke="#10b981" stroke-width="2" d="M8 12l2 2 4-4"/>
                            </svg>
                        </div>
                    </div>
                    <h2>Email Sent!</h2>
                    <p class="email-sent-message">We've sent a password reset link to <strong id="sent-email"></strong></p>
                    <p class="email-sent-note">Check your inbox and follow the link to reset your password.</p>
                </div>

                <button type="button" class="btn btn-secondary btn-full btn-lg" id="resend-btn" disabled>
                    <span id="resend-text">Resend email (<span id="countdown">60</span>s)</span>
                </button>
                <p class="resend-note" id="resend-note" style="display: none;">You can request another email now.</p>
            </div>

            <div class="auth-footer" id="auth-footer">
                Remember your password? <a href="{{ url_for('auth.login') }}">Sign in</a>
            </div>
        </div>
    </div>
</div>

<style>
.email-sent-animation {
    text-align: center;
    padding: 20px 0;
}

.email-icon {
    position: relative;
    display: inline-block;
    margin-bottom: 20px;
    color: var(--text-secondary, #64748b);
}

.email-icon svg:first-child {
    animation: emailBounce 0.6s ease-out;
}

.checkmark-circle {
    position: absolute;
    bottom: -5px;
    right: -5px;
    width: 28px;
    height: 28px;
}

.checkmark-circle svg {
    animation: checkmarkPop 0.4s ease-out 0.3s both;
}

.checkmark-check {
    stroke-dasharray: 20;
    stroke-dashoffset: 20;
    animation: checkmarkDraw 0.4s ease-out 0.5s forwards;
}

@keyframes emailBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

@keyframes checkmarkPop {
    0% { transform: scale(0); }
    70% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

@keyframes checkmarkDraw {
    to { stroke-dashoffset: 0; }
}

.email-sent-animation h2 {
    color: var(--text-primary, #f1f5f9);
    margin-bottom: 12px;
}

.email-sent-message {
    color: var(--text-secondary, #94a3b8);
    margin-bottom: 8px;
}

.email-sent-note {
    color: var(--text-muted, #64748b);
    font-size: 0.875rem;
}

.resend-note {
    text-align: center;
    font-size: 0.875rem;
    color: var(--text-muted, #64748b);
    margin-top: 12px;
}

#resend-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

#resend-btn:not(:disabled) {
    background-color: var(--bg-tertiary, #334155);
}
</style>

<script>
let countdownInterval = null;
let resendEmail = '';

document.getElementById('forgot-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = this;
    const email = document.getElementById('email').value;
    const submitBtn = document.getElementById('submit-btn');
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending...';
    
    try {
        const formData = new FormData(form);
        const response = await fetch(form.action || window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccessState(email);
        } else {
            alert(data.error || 'An error occurred. Please try again.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Send Reset Link';
        }
    } catch (error) {
        alert('An error occurred. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Send Reset Link';
    }
});

document.getElementById('resend-btn').addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    document.getElementById('resend-text').textContent = 'Sending...';
    
    try {
        const response = await fetch('{{ url_for("auth.forgot_password") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `csrf_token={{ csrf_token() }}&email=${encodeURIComponent(resendEmail)}`
        });
        
        const data = await response.json();
        
        if (data.success) {
            startCountdown();
            document.getElementById('resend-note').style.display = 'none';
        } else {
            alert(data.error || 'Failed to resend. Please try again.');
            btn.disabled = false;
            document.getElementById('resend-text').innerHTML = 'Resend email';
        }
    } catch (error) {
        alert('Failed to resend. Please try again.');
        btn.disabled = false;
        document.getElementById('resend-text').innerHTML = 'Resend email';
    }
});

function showSuccessState(email) {
    resendEmail = email;
    document.getElementById('forgot-form').style.display = 'none';
    document.getElementById('success-state').style.display = 'block';
    document.getElementById('sent-email').textContent = email;
    document.getElementById('subtitle').textContent = 'Check your inbox';
    
    startCountdown();
}

function startCountdown() {
    const resendBtn = document.getElementById('resend-btn');
    const countdownEl = document.getElementById('countdown');
    const resendText = document.getElementById('resend-text');
    const resendNote = document.getElementById('resend-note');
    
    resendBtn.disabled = true;
    resendNote.style.display = 'none';
    
    let seconds = 60;
    countdownEl.textContent = seconds;
    resendText.innerHTML = `Resend email (<span id="countdown">${seconds}</span>s)`;
    
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    
    countdownInterval = setInterval(() => {
        seconds--;
        const countdownSpan = document.getElementById('countdown');
        if (countdownSpan) {
            countdownSpan.textContent = seconds;
        }
        
        if (seconds <= 0) {
            clearInterval(countdownInterval);
            countdownInterval = null;
            resendBtn.disabled = false;
            resendText.textContent = 'Resend email';
            resendNote.style.display = 'block';
        }
    }, 1000);
}
</script>
{% endblock %}
