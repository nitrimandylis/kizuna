{% extends "base.html" %}

{% block title %}Calendar - Kizuna{% endblock %}

{% block content %}
<div class="standard-page">
    <div class="page-header">
        <h1>Event Calendar</h1>
        <p>View all upcoming CAS events in a monthly calendar view</p>
    </div>
    
    <div class="calendar-page-content">
        <div class="calendar-controls">
            <button class="btn btn-ghost" id="prevMonth">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Previous
            </button>
            <div class="calendar-title-wrapper">
                <h2 class="calendar-page-title" id="calendarTitle"></h2>
                <button class="btn btn-sm btn-secondary" id="todayBtn">Today</button>
            </div>
            <button class="btn btn-ghost" id="nextMonth">
                Next
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
        </div>
        
        <div class="calendar-legend">
            <div class="legend-item">
                <span class="legend-dot cas-creativity"></span>
                <span>Creativity</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot cas-activity"></span>
                <span>Activity</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot cas-service"></span>
                <span>Service</span>
            </div>
        </div>
        
        <div class="calendar-large" id="calendar">
            <div class="calendar-weekdays-large">
                <div>Sunday</div>
                <div>Monday</div>
                <div>Tuesday</div>
                <div>Wednesday</div>
                <div>Thursday</div>
                <div>Friday</div>
                <div>Saturday</div>
            </div>
            <div class="calendar-days-large" id="calendarDays"></div>
        </div>
    </div>
</div>

<style>
.calendar-page-content {
    padding: 0 2rem 3rem;
    max-width: 1400px;
    margin: 0 auto;
    flex: 1;
}

.calendar-controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    gap: 1rem;
}

.calendar-title-wrapper {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.calendar-page-title {
    font-size: 1.75rem;
    font-weight: 600;
    margin: 0;
}

.calendar-legend {
    display: flex;
    gap: 2rem;
    margin-bottom: 1.5rem;
    justify-content: center;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: var(--text-muted);
}

.legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.legend-dot.cas-creativity {
    background: var(--primary);
}

.legend-dot.cas-activity {
    background: var(--success);
}

.legend-dot.cas-service {
    background: var(--warning);
}

.calendar-large {
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.calendar-weekdays-large {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: var(--navy-light);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
}

.calendar-weekdays-large div {
    padding: 1.25rem 0.5rem;
    text-align: center;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.calendar-days-large {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
}

.calendar-day-large {
    display: flex;
    flex-direction: column;
    min-height: 140px;
    border-right: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    transition: var(--transition);
}

.calendar-day-large:nth-child(7n) {
    border-right: none;
}

.calendar-day-large:nth-child(n+36) {
    border-bottom: none;
}

.calendar-day-large:hover {
    background: var(--navy-light);
}

.calendar-day-large.other-month {
    opacity: 0.4;
}

.calendar-day-large.today {
    background: rgba(254, 67, 89, 0.05);
}

.calendar-day-header-large {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 0.75rem;
    flex-shrink: 0;
}

.calendar-day-number-large {
    font-size: 1rem;
    font-weight: 500;
    color: var(--text-muted);
    min-width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.calendar-day-large.today .calendar-day-number-large {
    background: var(--primary);
    color: white;
    border-radius: 50%;
    font-weight: 700;
}

.calendar-events-list {
    flex: 1;
    padding: 0 0.5rem 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    overflow: hidden;
}

.calendar-event-large {
    display: block;
    padding: 0.4rem 0.6rem;
    font-size: 0.85rem;
    font-weight: 500;
    border-radius: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    transition: var(--transition);
    cursor: pointer;
    border-left: 3px solid transparent;
}

.calendar-event-large:hover {
    transform: translateX(2px);
    text-decoration: none;
}

.calendar-event-large.cas-creativity {
    background: rgba(254, 67, 89, 0.1);
    color: var(--primary-light);
    border-left-color: var(--primary);
}

.calendar-event-large.cas-creativity:hover {
    background: rgba(254, 67, 89, 0.2);
}

.calendar-event-large.cas-activity {
    background: rgba(52, 211, 153, 0.1);
    color: var(--success);
    border-left-color: var(--success);
}

.calendar-event-large.cas-activity:hover {
    background: rgba(52, 211, 153, 0.2);
}

.calendar-event-large.cas-service {
    background: rgba(251, 191, 36, 0.1);
    color: var(--warning);
    border-left-color: var(--warning);
}

.calendar-event-large.cas-service:hover {
    background: rgba(251, 191, 36, 0.2);
}

.calendar-more-events {
    font-size: 0.75rem;
    color: var(--text-muted);
    padding: 0.25rem 0.6rem;
    font-style: italic;
}

@media (max-width: 1024px) {
    .calendar-day-large {
        min-height: 120px;
    }
    
    .calendar-event-large {
        font-size: 0.8rem;
        padding: 0.3rem 0.5rem;
    }
}

@media (max-width: 768px) {
    .calendar-page-content {
        padding: 0 1rem 2rem;
    }
    
    .calendar-controls {
        flex-wrap: wrap;
    }
    
    .calendar-controls .btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
    }
    
    .calendar-page-title {
        font-size: 1.35rem;
    }
    
    .calendar-weekdays-large div {
        padding: 0.75rem 0.25rem;
        font-size: 0.7rem;
    }
    
    .calendar-weekdays-large div:nth-child(n+4):not(:nth-child(7)) {
        font-size: 0.7rem;
    }
    
    .calendar-weekdays-large div::before {
        content: attr(data-short);
    }
    
    .calendar-weekdays-large div {
        font-size: 0;
    }
    
    .calendar-weekdays-large div:nth-child(1)::before { content: 'Sun'; }
    .calendar-weekdays-large div:nth-child(2)::before { content: 'Mon'; }
    .calendar-weekdays-large div:nth-child(3)::before { content: 'Tue'; }
    .calendar-weekdays-large div:nth-child(4)::before { content: 'Wed'; }
    .calendar-weekdays-large div:nth-child(5)::before { content: 'Thu'; }
    .calendar-weekdays-large div:nth-child(6)::before { content: 'Fri'; }
    .calendar-weekdays-large div:nth-child(7)::before { content: 'Sat'; }
    
    .calendar-day-large {
        min-height: 80px;
    }
    
    .calendar-day-header-large {
        padding: 0.5rem;
    }
    
    .calendar-day-number-large {
        font-size: 0.85rem;
        min-width: 24px;
        height: 24px;
    }
    
    .calendar-events-list {
        padding: 0 0.25rem 0.25rem;
        gap: 0.2rem;
    }
    
    .calendar-event-large {
        font-size: 0.7rem;
        padding: 0.2rem 0.35rem;
    }
    
    .calendar-legend {
        gap: 1rem;
    }
    
    .legend-item {
        font-size: 0.8rem;
    }
    
    .legend-dot {
        width: 10px;
        height: 10px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarDays = document.getElementById('calendarDays');
    const calendarTitle = document.getElementById('calendarTitle');
    const prevBtn = document.getElementById('prevMonth');
    const nextBtn = document.getElementById('nextMonth');
    const todayBtn = document.getElementById('todayBtn');
    
    if (calendarDays && calendarTitle) {
        let currentDate = new Date();
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];
        
        function renderCalendar(date, events) {
            const year = date.getFullYear();
            const month = date.getMonth();
            
            calendarTitle.textContent = monthNames[month] + ' ' + year;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            const today = new Date();
            const todayStr = today.getFullYear() + '-' + 
                            String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(today.getDate()).padStart(2, '0');
            
            const eventsByDate = {};
            if (events) {
                events.forEach(function(event) {
                    if (!eventsByDate[event.date]) {
                        eventsByDate[event.date] = [];
                    }
                    eventsByDate[event.date].push(event);
                });
            }
            
            const totalCells = 42;
            
            let html = '';
            let dayCount = 1;
            let nextMonthDay = 1;
            
            for (let i = 0; i < totalCells; i++) {
                let dayNumber;
                let isOtherMonth = false;
                let isToday = false;
                let dateStr = '';
                
                if (i < startDay) {
                    dayNumber = daysInPrevMonth - startDay + i + 1;
                    isOtherMonth = true;
                } else if (dayCount > daysInMonth) {
                    dayNumber = nextMonthDay;
                    nextMonthDay++;
                    isOtherMonth = true;
                } else {
                    dayNumber = dayCount;
                    const m = String(month + 1).padStart(2, '0');
                    const d = String(dayCount).padStart(2, '0');
                    dateStr = year + '-' + m + '-' + d;
                    
                    if (dateStr === todayStr) {
                        isToday = true;
                    }
                    dayCount++;
                }
                
                const classes = ['calendar-day-large'];
                if (isOtherMonth) classes.push('other-month');
                if (isToday) classes.push('today');
                
                html += '<div class="' + classes.join(' ') + '">';
                html += '<div class="calendar-day-header-large">';
                html += '<span class="calendar-day-number-large">' + dayNumber + '</span>';
                html += '</div>';
                html += '<div class="calendar-events-list">';
                
                if (dateStr && eventsByDate[dateStr]) {
                    const visibleEvents = eventsByDate[dateStr].slice(0, 4);
                    visibleEvents.forEach(function(event) {
                        html += '<a href="/events/' + event.id + '" class="calendar-event-large cas-' + event.cas_type + '" title="' + event.title + '">';
                        html += event.title;
                        html += '</a>';
                    });
                    if (eventsByDate[dateStr].length > 4) {
                        html += '<span class="calendar-more-events">+' + (eventsByDate[dateStr].length - 4) + ' more</span>';
                    }
                }
                
                html += '</div>';
                html += '</div>';
            }
            
            calendarDays.innerHTML = html;
        }
        
        function fetchEvents(year, month) {
            calendarDays.style.opacity = '0.5';
            
            fetch('/api/events?year=' + year + '&month=' + month)
                .then(function(response) {
                    return response.json();
                })
                .then(function(events) {
                    renderCalendar(currentDate, events);
                    calendarDays.style.opacity = '1';
                })
                .catch(function(error) {
                    console.error('Error fetching events:', error);
                    renderCalendar(currentDate, []);
                    calendarDays.style.opacity = '1';
                });
        }
        
        function loadCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            fetchEvents(year, month);
        }
        
        if (prevBtn) {
            prevBtn.addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() - 1);
                loadCalendar();
            });
        }
        
        if (nextBtn) {
            nextBtn.addEventListener('click', function() {
                currentDate.setMonth(currentDate.getMonth() + 1);
                loadCalendar();
            });
        }
        
        if (todayBtn) {
            todayBtn.addEventListener('click', function() {
                currentDate = new Date();
                loadCalendar();
            });
        }
        
        loadCalendar();
    }
});
</script>
{% endblock %}
